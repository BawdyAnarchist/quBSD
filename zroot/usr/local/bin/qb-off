#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-off.sh

get_options() {
	while getopts aehr opts ; do
		case $opts in
			a) ALL="true" ;;
			e) EXCLUDE="true" ;;
			h) get_msg_off "none" "usage_0" ;; 
			r) RESTART="true" ;;
		esac
	done

	shift $(( OPTIND - 1 ))
	
	_JAILS="$@"

	# Library function
	ONJAILS=$(get_onjails)
}

checks() {
	if [ -z "${ALL}${EXLUDE}${_JAILS}" ] ; then
		# Did not specify an action
		get_msg_off "_1" "usage_1"

	elif [ "$ALL" -a "$EXCLUDE" ] ; then
		# Mutually exclusive actions
		get_msg_off "_2" "usage_1"

	fi
}

remove_list() {
	if [ -n "$ALL" ] ; then 
		# _remove list is the same as all jails that are on
		_remove="$ONJAILS"

	elif [ -n "$EXCLUDE" ] ; then
		# Remove jails presentin the user input exclude list
		for _jail in $_JAILS ; do
			_remove=$(echo $ONJAILS | sed "s/$_jail//")
		done

	else	
		# Default action is to remove the user input jail list
		_remove="$_JAILS"
	fi
}

remove() {
	for _jail in $_remove; do

		if [ "$RESTART" ] ; then 

			restart_jail "$_jail" 
		else
			stop_jail "$_jail" &
			
			# Stopping jails right on top of each other can cause oddities with ifconfig 
			sleep .4
		fi
	done
}


get_global_variables

get_options "$@"

checks 

remove_list

remove


