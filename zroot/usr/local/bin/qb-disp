#!/bin/sh

# IMPROVEMENT: Make it so that a command can be run immediately at terminal launch.
# IMPROVEMENT: Add option for automatic network connection (tunnel). Auto IP.  

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-disp.sh

get_options() {
	while getopts h opts ; do
		case $opts in
			h) get_msg_qb_disp "none" "usage_0" ;;
		esac
	done

	shift $(( OPTIND - 1 ))

	# Define script variables
	JAIL="$1"
	DATETIME=$(date +%b%d_%H%M)
	NEWSNAP="${ZUSR_ZFS}/${JAIL}@DISP${DATETIME}"
}

newjail_name() {
	# Just one check. No need for a separate function
	check_isvalid_jail "$JAIL" "pass" || get_msg_qb_disp "none" "usage_1"
	
	# Make name visually easy to identify
	NEWJAIL="DISP-${JAIL}"
	_cycle=''

	# If DISP-jail exists (even partially), increment the ending number and try again 
	while zfs list -rt all | grep -Eqs "^${JAILS_ZFS}/$NEWJAIL[[:blank:]]" || \
			zfs list -rt all | grep -Eqs "^${ZUSR_ZFS}/$NEWJAIL[[:blank:]]" || \
			grep -Eqs "^$NEWJAIL[[:blank:]]" $JMAP || \
			grep -Eqs "^$NEWJAIL[[:blank:]]" $JCONF 
	do
		_cycle=$(( _cycle + 1 ))	
		NEWJAIL="DISP-${JAIL}_${_cycle}"
	done	

	echo "$NEWJAIL"
}

main() {
	# New snapshot ensures the most up-to-date version of the template jail
	zfs snapshot $NEWSNAP

	#Trap to destroy snapshot after use.
	trap 'zfs destroy -rRf $NEWSNAP' SIGINT SIGTERM SIGHUP SIGKILL SIGQUIT EXIT

	# Create dispjail and edit no_destroy flag
	qb-create -c dispjail -t none -i none -T $JAIL $NEWJAIL 
	qb-edit -f $NEWJAIL no_destroy false

	#Trap to ensure DISP doesn't remain after use
	trap	'destroy_dispjail' SIGINT SIGTERM SIGHUP SIGKILL SIGQUIT EXIT

	# Launch a floating terminal for the dispjail
	xterm -e csh -c "i3-msg -q floating enable, move position center; qb-cmd $NEWJAIL"
}

destroy_dispjail() {
	stop_jail "$NEWJAIL"
	zfs destroy -rRf ${JAILS_ZFS}/$NEWJAIL
	zfs destroy -rRf ${ZUSR_ZFS}/$NEWJAIL
	zfs destroy $NEWSNAP
	sed -i '' -E "/^${NEWJAIL}[[:blank:]]/d" $JMAP
	sed -i '' -E "\@${NEWJAIL}[[:blank:]]*\{@,\@^[[:blank:]]*\}[[:blank:]]*\$@d" $JCONF
}

get_global_variables

get_options "$@"

newjail_name

main



