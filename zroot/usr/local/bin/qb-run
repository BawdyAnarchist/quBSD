#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-autostart.sh

get_options() {
	while getopts hs opts ; do
		case $opts in
			h) get_msg_qb_run "none" "usage_0" ;;
			r) 
		esac
	done

	shift $(( OPTIND - 1 ))

	AUTOSTART=$(grep -E "autostart[[:blank:]]+true" $JMAP | awk '{print $1}')
}

autostart() {

	# Find all jails in JMAP flagged for autostart
	
	for _jail in $AUTOSTART ; do

		# Jails with a tunnel not yet started, will need to wait for tunnel to start 
		_tunnel=$(sed -nE "s/^${_jail}[[:blank:]]+tunnel[[:blank:]]+//p" $JMAP)

		# Switch on the basis of whether tunnel is running
		if jls -j "$_tunnel" > /dev/null 2>&1 ; then

			# Start jail, send start process to background, and move to next
			jail -c $_jail & 

		else	

			# Start jail and wait for completion
			jail -c $_jail 
		fi
	done
}


get_global_variables

get_options "$@"




