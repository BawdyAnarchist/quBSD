#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-edit.sh

get_options() {
	local OPTIND
	while getopts fhiqr opts ; do
		case $opts in
			   # [-f] acts on msg-edit function, rather than main script 
			f) FORCE="true" ;; 
			h) get_msg_qb_edit "none" "usage_0" ;; 
			i) PARAM="IP0" ; VAL="auto" ;;
			q) QUIET="true" ; _q='-q' ;;
			r) RESTART="true" ;;
		esac
	done

	shift $(( OPTIND - 1 ))
	
	# Script variables 
	JAIL="$1"
	PARAM="${PARAM:-"$2"}"
	VAL="${VAL:-"$3"}"
	OLDSETTING=$(sed -nE "s@^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+@@p" $JMAP)
}

checks() {
	# Check for required inputs
	if [ -z "$JAIL" -o -z "$PARAM" -o -z "$VAL" ] ; then
		# Only exception to missing input, is for [-i] auto assign IP 
		[ -z "$AUTO_IP" ]  &&  get_msg_qb_edit "_1" "usage_1"
	
	elif ! grep -Eqs "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+" $JMAP ; then
		# Doesn't exist in jmap (thus, can't be edited)
		get_msg_qb_edit "_2" "usage_1"

	elif [ "$VAL" == "$OLDSETTING" ] ; then
		# New value is unchanged from old value 
		get_msg_qb_edit "_3" "usage_0"

	fi	

	# Sanity checks to make sure values are reasonable
	case $PARAM in
		autostart|no_destroy)
				[ "$VAL" == "true" -o "$VAL" == "false" ] || get_msg_qb_edit "_4" "usage_1"
		;;
		class)
				get_msg_qb_edit "_5" "none" "_f"
		;;
		cpuset)
				check_isvalid_cpuset $_q "$VAL" || get_msg_qb_edit "none" "usage_1" 
		;;
		maxmem)
				check_isvalid_maxmem $_q "$VAL" || get_msg_qb_edit "none" "usage_1" 
		;;
		rootjail|template)
				# Check that rootjail or template has jmap and zroot zfs 
				check_isvalid_jail $_q "$VAL" || get_msg_qb_edit "none" "exit_1" "_f"
		;;
		schg) 
				check_isvalid_schg $_q "$VAL" ||  get_msg_qb_edit "none" "usage_1" 
		;;	
		seclvl)		
				check_isvalid_seclvl $_q "$VAL" ||  get_msg_qb_edit "none" "usage_1" 
		;;
		gateway)  
				check_isvalid_gateway $_q "$VAL" "$JAIL" \
						|| get_msg_qb_edit "none" "exit_1" "_f"
		;;
		IP0) 
				# It's possible user might try to assign DHCP from command line
				if [ "$VAL" == "auto" ] || [ "$VAL" == "DHCP" ] ; then 

					# Function returns available IPv4. Or for net-firewall returns "DHCP"
					VAL=$(discover_open_ipv4 $_q "$JAIL") \
							|| get_msg_qb_edit "none" "exit_1"

				else
					# Check IP addresses for validity and quBSD convention adherence 
					check_isvalid_ipv4 $_q "$VAL" "$JAIL" \
							|| get_msg_qb_edit "none" "exit_1" 

					check_isqubsd_ipv4 $_q "$VAL" "$JAIL" \
							|| get_msg_qb_edit "none" "exit_1" "_f"
				fi
		;; 
		# Catch all. Any other entries for $PARAM return an error (really should be necessary).
		*)	get_msg_qb_edit "_6" "usage_1"  ;;
	
	# /PARAM
	esac
}

main() {
	# Modify JMAP and print new settings on success
	sed -i '' -E "\@^${JAIL}[[:blank:]]+${PARAM}@s@[^[:blank:]]+\$@${VAL}@" $JMAP \
			&& get_msg_qb_edit "_8" 

	# Clean up the columns 
	_newJMAP=$(column -t $JMAP)
	echo "$_newJMAP" > $JMAP

	# Special handling case for net-firewall, to modify rc.conf 
	if [ "$JAIL" == "net-firewall" ] ; then
		
		# Relevant variables. 
		_tap=$(sed -nE "s/^${JAIL}[[:blank:]]+gateway[[:blank:]]+//p" $JMAP)
		_rcconf="${M_ZUSR}/net-firewall/rw/etc/rc.conf"
		chflags noschg "$_rcconf"	

		if [ "$VAL" == "DHCP" ] ; then
			sed -i '' -E "s/ifconfig_${_tap}.*/ifconfig_${_tap}=\"DHCP\"/" $_rcconf
			sed -i '' -E "/defaultrouter=/ d" $_rcconf

		else
			# Using `#' as sed separator, because `/' interferes with variable expansion
			sed -i '' -E "s#ifconfig_${_tap}.*#ifconfig_${_tap}=\"inet ${VAL}\"#g" $_rcconf
			sed -i '' -E "/^defaultrouter=.*/ d" $_rcconf
			sed -i '' -E "/^ifconfig_${_tap}.*/ a\\
defaultrouter=\"${VAL%.*/*}.1\"" $_rcconf
		fi
	fi
}

handle_restarts() {
	# If jail is off, don't offer restart. Still need gateway, so assign newvar: _jail_
	check_isrunning_jail $JAIL && _jail_="$JAIL" 

	# Define which jails need to be restarted
	case $PARAM in 

		cpuset|maxmem|rootjail|schg|seclvl|template)
			_restarts="       $_jail_" 
		;;
		IP0|gateway)
			_gateway=$(sed -nE "s/^${JAIL}[[:blank:]]+gateway[[:blank:]]+//p" $JMAP)
			check_isrunning_jail $_gateway || unset _gateway

			# This prevents `none' and `tap0' from being flagged for restart 
			if [ "$_gateway" == "none" ] || [ -z "${_gateway##tap[[:digit:]]}" ] ; then
				_restarts="       $_jail_" 
			else	
				_restarts=$(printf "%b" "       $_jail_\n       $_gateway")
			fi
		;;	
	esac

	# If there are no jails to restart, exit
	[ -z "$_jail_" ] && [ -z "$_gateway" ] && exit 0
	
	# If QUIET tagged, only continue if users specified a restart
	[ -n "$QUIET" ] && [ -z "$RESTART" ] && exit 0

	# Query user to restart jails 
	if [ -z "$RESTART" ] && [ -z "$QUIET" ] ; then

		get_msg_qb_edit "_7"
		get_user_response || exit 0 
	fi
	
	# Restart jails (otherwise, would've already exited)	
	for _jail in $_restarts ; do

		# "hold" option prevents starting jail if it is off
		[ "$_jail" == "none" ] || restart_jail "$_jail" "hold" 
	done
}

get_global_variables 

get_options "$@"

checks

main

handle_restarts


