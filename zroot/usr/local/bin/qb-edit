#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-edit.sh

get_options() {
	local OPTIND
	while getopts fhiqr opts ; do
		case $opts in
			   # [-f] acts on msg-edit function, rather than main script 
			f) FORCE="true" ; _q='-q' ;; 
			h) get_msg_edit "none" "usage_0" ;; 
			q) QUIET="true" ; _q='-q' ;;
			r) RESTART="true" ;;
			*) exit 1 ;;
		esac
	done

	shift $(( OPTIND - 1 ))
	
	# Script variables 
	JAIL="$1"
	PARAM="${PARAM:-"$2"}"
	VAL="${VAL:-"$3"}"
	OLDSETTING=$(sed -nE "s@^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+@@p" $JMAP)

	# Convert lower-case entered parameters to upper (user-friendly)
	[ "$PARAM" ] && PARAM=$(echo "$PARAM" | tr '[:lower:]' '[:upper:]')
}

checks() {
	# Check for required inputs
	if [ -z "$JAIL" -o -z "$PARAM" -o -z "$VAL" ] ; then
		# Only exception to missing input, is for [-i] auto assign IP 
		[ -z "$AUTO_IP" ]  &&  get_msg_edit "_1" "usage_1"
	
	elif ! grep -Eqs "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+" $JMAP ; then
		# Doesn't exist in jmap (thus, can't be edited)
		get_msg_edit "_2" "usage_1"

	elif [ "$VAL" = "$OLDSETTING" ] ; then
		# New value is unchanged from old value 
		get_msg_edit "_3" "usage_0"
	fi	

	# Sanity checks to make sure values are reasonable
	case $PARAM in
		AUTOSNAP)
				get_jail_parameter CLASS $JAIL

				# Only appjails and rootjails can have autosnaps=true
				[ $CLASS = "dispjail" ] && [ "$VAL" = "true" ] \
						&& get_msg_edit "_11" "exit_1"
		;;
		AUTOSTART|NO_DESTROY)
				chk_truefalse $_q "$VAL" "$PARAM" || get_msg_edit "_4" "usage_1"
		;;
		CLASS)
				get_msg_edit "_5" "usage_1" "_f"  
		;;
		CPUSET)
				chk_valid_cpuset $_q "$VAL" || get_msg_edit "none" "usage_1" 
		;;
		MAXMEM)
				chk_valid_maxmem $_q "$VAL" || get_msg_edit "none" "usage_1" 
		;;
		MTU)
				chk_valid_mtu $_q "$VAL" || get_msg_edit "none" "usage_1" 
		;;
		ROOTJAIL|TEMPLATE)
				# Check that rootjail or template has jmap and zroot zfs 
				chk_valid_jail $_q "$VAL" || get_msg_edit "none" "exit_1" "_f"
		;;
		SCHG) 
				chk_valid_schg $_q "$VAL" ||  get_msg_edit "none" "usage_1" 
		;;	
		SECLVL)		
				chk_valid_seclvl $_q "$VAL" ||  get_msg_edit "none" "usage_1" 

				# Alert user that high seclvl will make pf changes impossible
				[ "$VAL" = "3" ] && [ -z "${JAIL##net-*}" ] && get_msg_edit "_12" "_cont"
		;;
		GATEWAY)  
				chk_valid_gateway $_q "$VAL" "$JAIL" \
						|| get_msg_edit "none" "exit_1" "_f"

				get_jail_parameter -qs IPV4 "$JAIL"

				# Offer to change IPV4 from 'none' to 'auto', if gateway is valid
				if ! [ "$VAL" = "none" ] && [ "$IPV4" = "none" ] ; then
					get_msg_edit "_10"
					get_user_response && _IPAUTO="true" 
				fi
		;;
		IPV4) 
				# Check IP addresses for validity and quBSD convention adherence 
				chk_valid_ipv4 $_q "$VAL" \
						|| get_msg_edit "none" "exit_1" 

				chk_isqubsd_ipv4 $_q "$VAL" "$JAIL" \
						|| get_msg_edit "none" "exit_1" "_f"
		;; 
		# Catch all. Any other entries for $PARAM return an error.
		*)	get_msg_edit "_6" "usage_1"  ;;
	
	# /PARAM
	esac
}

modify_jmap() {

	# Modify JMAP and print new settings on success
	sed -i '' -E "\@^${JAIL}[[:blank:]]+${PARAM}@s@[^[:blank:]]+\$@${VAL}@" $JMAP \
			&& get_msg_edit "_8" 

	# Set IPV4 to auto in JMAP, if the user approved it 
	[ "$_IPAUTO" ] \
		&& sed -i '' -E "\@^${JAIL}[[:blank:]]+IPV4@s@[^[:blank:]]+\$@auto@" $JMAP 

	# Clean up the columns 
	_newJMAP=$(column -t $JMAP)
	echo "$_newJMAP" > $JMAP
}

modify_autosnap() {

	# Class is necessary to know which dataset to operate on (zroot or zusr)
	get_jail_parameter CLASS $JAIL	

	# zusr mod for appjails. Dispjails may or may not need zusr. Do both, no harm, lazy code
	! [ "$CLASS" = "rootjail" ] && _ZFS="${ZUSR_ZFS}/${JAIL}" \
			&& chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VAL}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"

	# zroot mod for rootjails. Dispjails may or may not need zroot. Do both, no harm, lazy code
	! [ "$CLASS" = "appjail" ] && _ZFS="${JAILS_ZFS}/${JAIL}" \
			&& chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VAL}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"
}

handle_vm_gateway() {
		
		# Relevant variables. 
		_gateway=$(get_jail_parameter -deqs GATEWAY $JAIL)
		_tap=$(get_jail_parameter -deqs VIF $_gateway)
		_rcconf="${M_ZUSR}/net-firewall/rw/etc/rc.conf"
		chflags noschg "$_rcconf"	

		if [ "$VAL" = "DHCP" ] ; then
			sed -i '' -E "s/ifconfig_${_tap}.*/ifconfig_${_tap}=\"DHCP\"/" $_rcconf
			sed -i '' -E "/defaultrouter=/ d" $_rcconf

		else

			# Using `#' as sed separator, because `/' interferes with variable expansion
			sed -i '' -E "s#ifconfig_${_tap}.*#ifconfig_${_tap}=\"inet ${VAL}\"#g" $_rcconf
			sed -i '' -E "/^defaultrouter=.*/ d" $_rcconf
			
			# This might not be completley robust. Generally a.b.c.1 should be the default.
			sed -i '' -E "/^ifconfig_${_tap}.*/ a\\
defaultrouter=\"${VAL%.*/*}.1\"" $_rcconf
		fi

		# Warn about having modified IP for net-firewall		
		get_msg_edit "_9"
}

handle_restarts() {
	# Logic could be written to change running jails, but simpler just to restart.
	case $PARAM in 

		CPUSET|MAXMEM|MTU|ROOTJAIL|SCHG|SECLVL|TEMPLATE)
			chk_isrunning $JAIL && _restart1="$JAIL"
		;;
		IPV4|GATEWAY)
			_gateway=$(get_jail_parameter -deqs GATEWAY $JAIL)

			# If jail is running it needs restarted
			if chk_isrunning $JAIL ; then
				_restart1="$JAIL" ; _restart2="$_gateway"

			else
				chk_isrunning $_gateway && _restart2="$_gateway"
			fi
		;;	
	esac

	# If there are no jails to restart, exit
	[ -z "$_restart1" ] && [ -z "$_restart2" ] && exit 0
	
	# If QUIET tagged, only continue if user specified a restart
	[ -n "$QUIET" ] && [ -z "$RESTART" ] && exit 0

	if [ -z "$QUIET" ] ; then 
		get_msg_edit "_7"
		get_user_response || return 0 
	fi
	
	# Restart jails (otherwise, would've already exited)	
	for _jail in $_restart2 $_restart1 ; do
		[ "$_jail" = "none" ] || restart_jail "$_jail" 
	done
}

main() {

	# jailmap.conf edits	
	modify_jmap

	# Autosnap requires zfs changes
	[ "$PARAM" = "AUTOSNAP" ] && modify_autosnap

	# Special case for net-firwell. Will need to eventually be generalized with VM handling. 
	[ "$JAIL" = "net-firewall" ] && [ "$PARAM" = "IPV4" ] && handle_vm_gateway 
	
	handle_restarts
}


get_global_variables 

get_options "$@"

checks

main


