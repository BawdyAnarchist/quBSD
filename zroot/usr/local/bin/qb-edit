#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-edit.sh

get_options() {
	while getopts dfhqr opts ; do case $opts in
		d) ACTION="delete" ;;
		f) FORCE="true" ; _q='-q' ;;
		h) get_msg_edit "none" "usage_0" ;;
		q) QUIET="true" ; _q='-q' ;;
		r) RESTART="true" ;;
		*) exit 1 ;;
   esac  ;  done  ;  shift $(( OPTIND - 1 ))

	# Script variables
	JAIL="$1"
	PARAM="$2"

	# If adding	a line, it might be '-s opt' for bhyve, need full line
	if [ "$PARAM" = "BHYVE_CUSTM" ] ; then
		shift 2
		VALUE="$@"
	else
		VALUE="$3"
	fi

	# Create both (upper/lower) for VALUE. User convenience, and for checks later on
	PARAM=$(echo  "$PARAM" | tr '[:lower:]' '[:upper:]')
	_param=$(echo "$PARAM" | tr '[:upper:]' '[:lower:]')

	# Necessary for editing lines vs adding lines
	OLDVALUE=$(grep -E "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]].*" $QMAP)
	DEFAULT=$(sed -En "s/^#default[[:blank:]]+${PARAM}[[:blank:]]+//p" $QMAP)

	# This will return global variables: CLASS and FILT_PARAMS
	get_parameter_lists "$JAIL"
}

checks() {

	if [ "$ACTION" = "delete" ] ; then
		# Make sure that at JAIL and PARAM exist
		[ -n "$JAIL" ] && [ -n "$PARAM" ] || get_msg_edit "_1" "usage_1"

		# Make sure at least one line exists to delete
		grep -Eqs "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+${VALUE}" $QMAP \
				|| get_msg_edit "_4" "exit_1"

	else
		# Need all 3 parameters
		[ -z "$JAIL" -o -z "$PARAM" -o -z "$VALUE" ] && get_msg_edit "_1" "usage_1"

		# Error if proposed entry already exists
		grep -Eqs "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+${VALUE}[[:blank:]]*\$" $QMAP \
																			&& get_msg_edit "_2" "exit_0"

		# Multi-line parameters receive a new line
		if echo "$MULT_LN_PARAMS" | grep -Eqs "$PARAM" ; then
			ACTION="add"

		# All other PARAMs must be checked for validity, and determine if new line is needed
		elif echo "$FILT_PARAMS" | grep -Eqs "$PARAM" ; then
			[ -z "$OLDVALUE" ] && ACTION="add"
			[ "$VALUE" = "$DEFAULT" ] && ACTION="revert_to_default"

		elif echo "$NON_QMAP" | grep -Eqs "$PARAM" ; then
			ACTION="none"

		# Values of the #default can be modified regardless of CLASS
		elif [ "$JAIL" = "#default" ] ; then :

		# Otherwise, PARAM was not found to be valid for the jail/VM
		else
			get_msg_edit "_3" "exit_1"
		fi

		# BHYVE_CUSTM is special, but everything else can test for chk_valid_param
		[ ! "$PARAM" = "BHYVE_CUSTM" ] \
				&& ! eval "chk_valid_${_param}" $_q '--' \"$VALUE\" \"$JAIL\" \
				&& [ -z "$FORCE" ] && exit 1
	fi

	# Extra checks/interaction for certain parameters and IPV4
	case $PARAM in

		# Should not be changing class, unless you really know what you're doing
		CLASS) get_msg_edit "_5" "exit_1" "_f" ;;

		# Warn about changing ROOTENV
		ROOTENV) get_msg_edit "_6" "warn" ;;

		GATEWAY)
				get_jail_parameter -dqs IPV4 "$JAIL"

				# Offer to change IPV4 from 'none' to 'auto', if gateway is valid
				if [ ! "$VALUE" = "none" ] && [ "$IPV4" = "none" ] ; then
					get_msg_edit "_10"
					get_user_response && _IPAUTO="true"
				fi
		;;
		IPV4)
				# Extra check for quBSD IPV4 convention.
				chk_isqubsd_ipv4 $_q "$VALUE" "$JAIL" || get_msg_edit "none" "exit_1" "_f"
		;;
	esac
}

modify_qmap() {

	case $ACTION in
		delete)
			_delline=$(grep -E "^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+${VALUE}" $QMAP)
			sed -i '' -E "\@^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+${VALUE}@ d" $QMAP
		;;
		revert_to_default)
			_default=$(grep -E "^#default[[:blank:]]+${PARAM}[[:blank:]]" $QMAP)
			sed -i '' -E "\@^${JAIL}[[:blank:]]+${PARAM}[[:blank:]]@ d" $QMAP
		;;
		add)
			echo "$JAIL  $PARAM  $VALUE" >> $QMAP
		;;
		none) :  # No action to take (devfs_ruleset)
		;;
		*) # Modify QMAP and print new settings on success
			sed -i '' -E "s@^(${JAIL}[[:blank:]]+${PARAM}[[:blank:]]+).*@\1${VALUE}@" $QMAP
		;;
	esac

	# Set IPV4 to auto in QMAP, if the user approved it
	[ "$_IPAUTO" ] \
		&& sed -i '' -E "\@^${JAIL}[[:blank:]]+IPV4@s@[^[:blank:]]+\$@auto@" $QMAP

	# Clean up the columns and sorting. Make sure there's no duplicates
	_newQMAP=$(column -t $QMAP | uniq)
	_newQMAP=$(echo "$_newQMAP" | sort -k1,1 -k2,2)
	echo "$_newQMAP" > $QMAP

	# BHYVE_CUSTM has extra spaces. At least remove the first space
	sed -i '' -E "s/(BHYVE_CUSTM[[:blank:]]+[^[:blank:]]+)[[:blank:]]+/\1 /" $QMAP
}

modify_autosnap() {

	# Class tells us which dataset to operate on (zroot or zusr)
	case $CLASS in

		# Rootjail only needs zroot operation
		rootjail)
			_ZFS="${R_ZFS}/${JAIL}"
			chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VALUE}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"
		;;

		# Appjail/VM will have zusr. Dispjail might, but if not will fail to continue
		appjail|cjail|dispjail|appVM)
			_ZFS="${U_ZFS}/${JAIL}"
			chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VALUE}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"
		;;

		# RootVM will almost certainly have both zroot and zusr (due to /vmusr mounted)
		rootVM)

			_ZFS="${R_ZFS}/${JAIL}"
			chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VALUE}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"

			_ZFS="${U_ZFS}/${JAIL}"
			chk_valid_zfs "$_ZFS" && zfs set qubsd:autosnap="${VALUE}" "$_ZFS" \
					&& zfs get qubsd:autosnap "$_ZFS"
		;;
	esac
}

modify_jconf_devfs() {

	# First convert the to just the numerical value if the user entered the long format
	VALUE=$(echo "$VALUE" | grep -Eo '[[:digit:]]+$')

# Hey, it's better than creating temp files to handle it. To explain what's going on here:
# 1) search for: '^JAIL {'  which is the opening stanza for the jail
# 2) :n  acts as a pointer, a way to loop over the same commands within sed
# 3) N tells sed to load the next line (into the pattern space)
# 4) Check the new line for ending curly '}' which would indicate end of jail entry in JCONF
#    in which case branch to :z , end of function, to prevent changing some other jail
# 5) If the line does not match .*devfs_rulset.* then branch to :n (loop)
# 6) Finally replace the line with the desired $value

sed -i '' -E "/^${JAIL}[[:blank:]]*\{/ {
:n
N
/\}/bz
/.*devfs_ruleset.*/!bn
s/(devfs_ruleset).*/\1=\"${VALUE}\";/

:z
}" $JCONF
}

handle_restarts() {
	# Logic could be written to change running jails, but simpler just to restart.
	case $PARAM in

		CPUSET|MAXMEM|MTU|ROOTENV|SCHG|SECLVL|TEMPLATE)
			chk_isrunning $JAIL && _restart1="$JAIL"
		;;
		IPV4|GATEWAY)
			_gateway=$(get_jail_parameter -deqs GATEWAY $JAIL)

			# If jail is running it needs restarted
			if chk_isrunning $JAIL ; then
				_restart1="$JAIL" ; _restart2="$_gateway"
			else
				chk_isrunning $_gateway && _restart2="$_gateway"
			fi
		;;
	esac

	# If there are no jails to restart, exit
	[ -z "$_restart1" ] && [ -z "$_restart2" ] && exit 0

	# If QUIET tagged, only continue if user specified a restart
	[ -n "$QUIET" ] && [ -z "$RESTART" ] && exit 0

	if [ -z "$QUIET" ] ; then
		get_msg_edit "_7"
		get_user_response || return 0
	fi

	# Restart jails (otherwise, would've already exited)
	for _jail in $_restart2 $_restart1 ; do
		[ "$_jail" = "none" ] || restart_jail "$_jail"
	done
}

main() {

	# Some edits are coordinated across other quBSD configs/params, for user-facing simplicity
	case "$PARAM" in
		AUTOSNAP)  modify_autosnap ; modify_qmap  ;;
		DEVFS_RULE) modify_jconf_devfs  ;;
		*) modify_qmap  ;;
	esac

	# Print the new value
	case $ACTION in
		delete) get_msg_edit "_8_1"  ;;
		revert_to_default) get_msg_edit "_8_2"  ;;
		*) get_msg_edit "_8"  ;;
	esac

	handle_restarts
}


get_global_variables

get_options "$@"

checks

main


