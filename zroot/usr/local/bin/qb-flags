#!/bin/sh

while getopts dhu o ; do
	case $o in
		d) DOWN="true" ;;
		h) HELP="true" ;;
		u) UP="true" ;; 
	esac
done

shift $(( OPTIND - 1 ))

JMAP="/usr/local/etc/quBSD/jailmap.conf"
QBCONF="/usr/local/etc/quBSD/quBSD.conf"
sed -i '' -e 's/[[:blank:]]*$//g' $JMAP    # Removes blanks at EOL, prevents errors

# Get datasets, mountpoints; and define files.
zusr_zfs=$(sed -En "s/^zusr_dataset[[:blank:]]+//p" $QBCONF) 
m_zusr=$(zfs get -H mountpoint $zusr_zfs | awk '{print $3}')
jails_zfs=$(sed -En "s/^jails_dataset[[:blank:]]+//p" $QBCONF) 
m_jails=$(zfs get -H mountpoint $jails_zfs | awk '{print $3}')


# Define script variables
JAIL="$1"

usage() {
	echo ""
	echo "qb-flags: Toggles schg/noschg for the indicated jail"
	echo ""
	echo "Usage: qb-flags [-h] [-d|-u] <jail>"	
	echo "   -d: (d)own: recursive noschg flags for target jail"
	echo "   -u: (u)p: re-applies jailmap settings to target jail"
   echo "   -h: (h)elp: Outputs this help message"
	echo ""
	exit 1
}

checks() {
	if [ "$HELP" ] ; then
		usage

	elif [ -z "$DOWN" -a -z "$UP" ] ; then
		echo "qb-flags: ERROR: must specify -d (down) or -u (up) for flags" 
		usage

	elif [ "$DOWN" -a "$UP" ] ; then
		echo "qb-flags: ERROR: must specify only one option, [-d or -u], not both" 
		usage

	elif [ -z "$JAIL" ] ; then
		echo "qb-flags: ERROR: must specify a target jail" 
		usage

	elif ! `qb-list -qj "$JAIL"` ; then
		echo "qb-flags: ERROR: $JAIL does not exist or is not configured properly"
		usage
	fi
}

checks

if [ "$DOWN" ] ; then
	chflags -R noschg ${m_jails}/$JAIL
	chflags -R noschg ${m_zusr}/$JAIL

elif [ "$UP" ] ; then
	/usr/local/etc/quBSD/exec.poststart $JAIL
fi


