#!/bin/sh

. /usr/local/lib/quBSD/quBSD.sh
. /usr/local/lib/quBSD/msg-destroy.sh

get_options() {
	while getopts h opts ; do
		case $opts in
			h) get_msg_destroy "none" "usage_0" ;;
			*) exit 1 ;;
		esac
	done

	shift $(( OPTIND - 1 ))

	JAIL="$1"
}

define_variables() {

	# No jail provided
	[ -z "$JAIL" ] && get_msg_destroy "_3" "usage_1"

	# Important parameters for checks
	get_jail_parameter -qd CLASS "$JAIL"
	get_jail_parameter -q NO_DESTROY "$JAIL"

	# Assume the jail either doesnt exist, or is partial. Dont require changing NO_DESTROY
	[ -z "$CLASS" ] && NO_DESTROY="false"

	OFFJAILS=$(zfs list -o name,origin | grep -E "$JAIL\@.*\$" \
									| awk '{print $1}' | sed "s@.*/@@")

	# Get sizes of datasets to be destroyed, and simulation messages from zfs
	if chk_valid_zfs ${ZUSR_ZFS}/${JAIL} ; then
		zusrSize=$(zfs list -o used ${ZUSR_ZFS}/${JAIL} | tail -1)
		zusrDestroy=$(zfs destroy -nvrRf ${ZUSR_ZFS}/${JAIL} | grep -v "${JAIL}\@")
	fi

	if	chk_valid_zfs ${JAILS_ZFS}/$JAIL ; then
		zrootSize=$(zfs list -o used ${JAILS_ZFS}/${JAIL} | tail -1)
		zrootDestroy=$(zfs destroy -nvrRf ${JAILS_ZFS}/${JAIL} | grep -v "${JAIL}\@")
	fi
}

checks() {

	# no_destroy protection flag still active
	[ "$NO_DESTROY" = "true" ] && get_msg_destroy "_2" "usage_1"

	# Extra reminder that they're destorying a rootjail
	[ -z "${CLASS##root*}" ] && [ -n "$CLASS" ] && get_msg_destroy "_4"

	# Message on datasets depends on if there's any dataset to destroy
	if [ -z "${zrootDestroy}${zusrDestroy}" ] ; then
		get_msg_destroy "_5_1"

	else
		# Print the datasets and amount of data to be destroyed
		get_msg_destroy "_5"
		[ -n "$zrootDestroy" ] && get_msg_destroy "_6"
		[ -n "$zusrDestroy" ] && get_msg_destroy "_7"

		# Solicit user response
		get_msg_destroy "_8"
		severe="severe"
	fi

	# "severe" requires a full `yes' to be typed
	get_user_response $severe || get_msg_destroy "_1" "exit_0"
}

main() {

	# Turn off all jails before applying changes
	for _jail in $JAIL $OFFJAILS ; do
		stop_jail -w "$_jail"
	done

	# Destroy datasets
	[ "$zrootDestroy" ] \
		&& chk_valid_zfs "${JAILS_ZFS}/${JAIL}" \
		&& zfs destroy -rRf ${JAILS_ZFS}/${JAIL}

	[ "$zusrDestroy" ] \
		&& chk_valid_zfs "${ZUSR_ZFS}/${JAIL}" \
		&& zfs destroy -rRf ${ZUSR_ZFS}/${JAIL}

	# Modify Files
	sed -i '' -E "/^${JAIL}[[:blank:]]/d" $QMAP
	sed -i '' -E "/^${JAIL}(\{|[[:blank:]])/,/^}/d" $JCONF
}


get_global_variables

get_options "$@"

define_variables

checks

main


