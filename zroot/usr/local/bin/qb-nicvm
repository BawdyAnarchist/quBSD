#!/bin/sh

while getopts chns o ; do
	case $o in
		c) console="true" ;;
		h) help="true" ;;
		n) no_run="true" ;;
		s) ssh="true" ;;
	esac
done

shift $(( OPTIND -1 ))

JMAP="/usr/local/etc/quBSD/jailmap.conf"
QBCONF="/usr/local/etc/quBSD/quBSD.conf"
sed -i '' -e 's/[[:blank:]]*$//g' $JMAP    # Removes blanks at EOL, prevents ERRors

define_variables() {
	nicvmIP=$(egrep "^nicvm[[:blank:]]+IP0" $JMAP | awk '{print $3}')
	tap=$(egrep "^nicvm[[:blank:]]+tunnel" $JMAP | awk '{print $3}')
	ppt_nic=$(sed -nE "s:ppt_nic[[:blank:]]+::p" $QBCONF) 
	zroot=$(sed -nE "s:quBSD_root[[:blank:]]+::p" $QBCONF) 

	firewallIP=$(egrep "^net-firewall[[:blank:]]+IP0" $JMAP | awk '{print $3}')

	# Determines if nicvm process is running
	pgrep -f 'bhyve: nicvm' >> /dev/null 2>&1 && vm_on="true"
}

define_messages() {
	ERR1=$(printf "%b" "qb-nicvm: ERROR: Must specify an option (action)") 
	ERR2=$(printf "%b" "qb-nicvm: ERROR: net-firewall IP should be valid IPv4")
	MSG3=$(printf "%b" "qb-nicvm: ALERT: nicvm is running. To access via console mode," \
				"\n(usually for troubleshooting), the script must first shutdown nicvm")
	ERR4=$(printf "%b" "qb-nicvm: ERROR: net-firewall must have tunnel set to: net-tap")
	ERR5=$(printf "%b" "qb-nicvm: ERROR: Could not start net-firewall. Exiting.")
	MSG6=$(printf "%b" "qb-nicvm: Waiting for nicvm to shutdown before launching console" \
				"\nPlease wait for 20 seconds.")
	MSG7=$(printf "%b" "qb-nicvm: Launching nicvm. Wait a moment")
	ERR8=$(printf "%b" "qb-nicvm: ERROR: [-n] should only be used with [-c] option")
}

usage() {
	[ "$ERR" ] && printf "%b" "\n$ERR\n"
	echo ""
	echo "qb-nicvm: Manages and automates nicvm connectivity"
	echo "If you just need to turn on/off nicvm, use service"
	echo ""
	echo "Usage: qb-nicvm [-c|-h|-s]" 
	echo ""
	echo "   -c: (c)onsole:  Launch nicvm with stdio on terminal console"
	echo "   -h: (h)elp:  Outputs this help message"
	echo "   -n: (n)o_run:  Don't run the console, just print the commands"
	echo "                  Use only in combination with -c option"
	echo "   -s: (s)sh:  Establish ssh connection into nicvm, via net-firewall"
	echo ""
	exit 1
}

checks() {
	if [ "$help" ] ; then 
		usage 

	elif [ "$OPTIND" = "1" ] ; then
		ERR="$ERR1" ; usage

	elif [ "$ssh" -a "$firewallIP" = "none" ] ; then
		ERR="$ERR2" ; usage

	elif [ "$ssh" -a -n "$no_run" ] ; then
		ERR="$ERR8" ; usage

	elif [ "$console" -a "$vm_on" ] ; then
		printf "%b" "\n$MSG3" 
		restart="true"
	fi
}

poweron_console_mode() {
	# Only print out commands if -n option is selected
	if [ -n "$no_run" ] ; then

		printf "%b" "\n\nbhyveload -c stdio -m 600M -d /dev/zvol/${zroot}/nicvm -S nicvm\n\n"

		printf "%b" "bhyve -c 1 -m 600M -H -A -P -S -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,"$tap" -s 3:0,virtio-blk,/dev/zvol/${zroot}/nicvm -s 4:0,passthru,"$ppt_nic" -l com1,stdio nicvm\n\n" 
		
		exit 0
	fi

	printf "%b" "\n$MSG7\n"

	bhyveload -c stdio -m 600M -d /dev/zvol/${zroot}/nicvm -S nicvm 

	bhyve -c 1 -m 600M -H -A -P -S \
		-s 0:0,hostbridge \
		-s 1:0,lpc \
		-s 2:0,virtio-net,"$tap" \
		-s 3:0,virtio-blk,/dev/zvol/${zroot}/nicvm \
		-s 4:0,passthru,"$ppt_nic" \
		-l com1,stdio \
		nicvm 
}	

main() {
	if [ "$restart" -a -z "no_run" ] ; then
		# I couldn't find a reliable way of ensuring a proper/full nicvm shutdown
		# Use a countdown from 20 seconds ... slightly dirty way of doing it 
		service nicvm stop	
		printf "%b" "\n\n$MSG6\n"

		count=1
		while [ $count -lt 20 ] ; do
			printf "$count .. "
			count=$(( count + 1 ))
			sleep 1
		done

		# After nicvm is shutdown, tap needs to be reset
		ifconfig $tap -vnet net-tap >> /dev/null 2>&1
		if `jls | grep -qs " net-tap "` ; then
			ifconfig $tap vnet net-tap 
			jexec -l -U root net-tap ifconfig bridge0 addm $tap
			jexec -l -U root net-tap ifconfig $tap up 
		fi
	fi

	if [ "$console" ] ; then
		poweron_console_mode
		exit 0
	fi

	if [ "$ssh" ] ; then
		# net-firewall must be on 
		`jls | grep -qs " net-firewall "` || jail -c net-firewall >> /dev/null 2>&1
		[ "$?" != "0" ] && ERR="$ERR5" && usage

		jexec -l -U root net-firewall ssh -i /root/.ssh/nicvm root@${nicvmIP%/*}
	fi
}

define_variables
define_messages
checks
main


