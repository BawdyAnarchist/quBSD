#!/bin/sh

. /usr/local/lib/quBSD/msg-dpi.sh

get_options() { 
	while getopts hr: opts ; do
		case $opts in
			h) get_msg_qb_dpi "none" "usage_0" ;;
			r) REVERT="$OPTARG" ;;
		esac
	done

	shift $(( OPTIND - 1 ))

	DPI_IN="$1" 
	
	# Scale references to typical standard default
	SCALE=96

	# REVERT defaults to 10 seconds unless otherwise specified
	REVERT="${REVERT:=10}"
	
	# Get starting DPI, just in case .Xresources doesn't have it stored
	DPI_START=$(xrdb -query | sed -nE "s/Xft.dpi:[[:blank:]]+//gp")
}

checks() {
	# DPI less that 0.5 is too low 
	echo "$DPI_IN < 0.3" | bc | grep -qs 1 && get_msg_qb_dpi "_1" "exit 1"

	# DPI between 4 and 29 is too high to be a scaled entry; too low to be raw
	echo "$DPI_IN > 4 && $DPI_IN < 29" | bc | grep -qs 1 && get_msg_qb_dpi "_2" "exit 1"

	# DPI above 384 (4x96) is too high for an automated script 
	echo "$DPI_IN > 384" | bc | grep -qs 1 && get_msg_qb_dpi "_3" "exit 1"
}

main() {
	# Convert scaled to raw
	echo "$DPI_IN >=29" | bc | grep -qs 1 \
			&& DPI_RAW="$DPI_IN" \
					|| DPI_RAW=$(echo "$DPI_IN * 96" | bc)

	# Change DPI	
	echo "Xft.dpi: $DPI_RAW" | xrdb -merge
}

revert_dpi() {

	sleep $REVERT 

	grep -Eq "Xft.dpi:[[:blank:]]+[[:digit:]]+" /root/.Xresources \
			&& xrdb -merge /root/.Xresources	\
					|| echo "Xft.dpi: $DEFAULT_DPI" | xrdb -merge 

}

get_options "$@"

checks 

main

revert_dpi &

exit 0
